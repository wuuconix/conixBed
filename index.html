<script src="https://at.alicdn.com/t/c/font_3850397_7uo84zf4u3.js"></script>
<script src="https://upcdn.b0.upaiyun.com/libs/jquery/jquery-2.0.2.min.js"></script>
<script src="./toast.min.js"></script>
<script src="./spark-md5.min.js"></script>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wuuconix's Image Bed</title>
  <link rel="icon" href="https://url.wuuconix.link/favicon">
  <link rel="stylesheet" href="./toast.css">
</head>
<body>
  <svg class="icon upload" aria-hidden="true">
    <use xlink:href="#icon-upload"></use>
  </svg>
  <div class="wrapper hidden">
    <img src="https://url.wuuconix.link/favicon" alt="">
    <div class="link">
      <input type="url" value="https://url.wuuconix.link/favicon" readonly>
      <button>
        <svg class="icon copy" aria-hidden="true">
          <use xlink:href="#icon-copy"></use>
        </svg>
      </button>
    </div>
  </div>
</body>
</html>

<script>

const svg = $$("svg")
svg.addEventListener("click", async () => {
  try {
    const img = await pickImg()
    upload(img)
  } catch(e) {
    console.log(e)
    Toast.error(String(e))
  }
})
const button = $$("button")
button.addEventListener("click", async () => {
  try {
    await navigator.clipboard.writeText($$("input").value)
    Toast.success("copy success")
  } catch(e) {
    Toast.error(String(e))
    console.log(e)
  }
})
async function upload(img) {
  const formData = new FormData()
  const nonce = Math.round(Math.random() * 1000000000)
  const ts = Math.trunc(+Date.now() / 1000)
  const token = "10c5a9d400c742cf8431a51df928d539"
  const sign = SparkMD5.hash(`${token}_${ts}_${nonce}`)
  console.log(`${token}_${ts}_${nonce}`)
  console.log(sign)
  formData.append("file", img, img.name)
  formData.append("nonce", String(nonce))
  formData.append("ts", String(ts))
  formData.append("token", token)
  formData.append("sign", sign)
  formData.append("categories", "PicGo")
  const res = await (await fetch("https://api.superbed.cn/upload", {
    method: "POST",
    headers: {
      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.134 Safari/537.36'
    },
    body: formData
  })).json()
  console.log(res)
  if (res.err === 0) {
    Toast.success("upload success")
    const img = $$("img")
    const input = $$("input")
    img.src = `https://pic.wuuconix.link/item/${res.ids[0]}`
    input.value = `https://pic.wuuconix.link/item/${res.ids[0]}`
    const upload = $$("svg.upload")
    const wrapper = $$("div.wrapper")
    upload.classList.add("hidden")
    wrapper.classList.remove("hidden")
  } else {
    throw JSON.stringify(res)
  }
}
async function pickImg() {
  const pickerOpts = {
    types: [
      {
        description: 'Images',
        accept: {
          'image/*': ['.png', '.gif', '.jpeg', '.jpg', '.webp'],
        },
      },
    ],
    excludeAcceptAllOption: true,
    multiple: false,
  }
  const [ fileHandle ] = await window.showOpenFilePicker(pickerOpts)
  const fileData = await fileHandle.getFile()
  return fileData
}
function $$(...args) {
  return document.querySelector(...args)
}
</script>

<style type="text/css">
html, body, .wrapper {
  width: 100%;
  height: 100%;
  padding: 0;
  margin: 0;
}
body {
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
}
svg.upload {
  margin-top: -10vh;
}
.hidden {
  display: none !important;
}
img, div.link, input, button {
  vertical-align: middle;
}
.wrapper {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
}
@media screen and (max-width: 560px) {
  .wrapper {
    flex-direction: column;
  }
}
img {
  max-width: 300px;
  box-shadow: 0 5px 11px 0 rgb(0 0 0 / 18%), 0 4px 15px 0 rgb(0 0 0 / 15%);
  border-radius: 0.25rem;
}
input {
  padding: 5px;
}
button {
  padding: 0;
}
svg.copy {
  width: 25px;
  height: 25px;
}
</style>